# MentorPiCore_Ext と ubuntu_in_MTP Docker イメージの関係

## 概要

MentorPiロボットシステムは、主に2つの主要コンポーネントで構成されています：

1. **MentorPiCore_Ext**: Raspberry Pi本体上で動作するベースシステム
2. **ubuntu_in_MTP**: Dockerコンテナとして実行されるUbuntuベースのROS2環境

この文書では、これら2つのコンポーネント間の関係と、それぞれの役割について説明します。

## システムアーキテクチャ

```
+------------------------------------------+
|             Raspberry Pi 5               |
|                                          |
|  +----------------------------------+    |
|  |        MentorPiCore_Ext          |    |
|  |  (Raspberry Pi OS / Base System) |    |
|  |                                  |    |
|  |  +----------------------------+  |    |
|  |  |      Docker Container      |  |    |
|  |  |                            |  |    |
|  |  |      ubuntu_in_MTP         |  |    |
|  |  |      (Ubuntu + ROS2)       |  |    |
|  |  +----------------------------+  |    |
|  +----------------------------------+    |
+------------------------------------------+
```

## MentorPiCore_Ext（ホストシステム）

MentorPiCore_Extは、Raspberry Pi本体上で動作するベースシステムです。Raspberry Pi OSをベースにしており、以下の役割を担っています：

### 主な役割

1. **ハードウェア管理**: 
   - Raspberry Piのハードウェアリソース（CPU、メモリ、GPIO）の管理
   - 周辺機器（カメラ、LiDAR、モーターなど）へのアクセス提供

2. **システム管理**:
   - ブートプロセスの管理
   - ネットワーク設定（WiFi、Ethernet）
   - 電源管理

3. **Dockerホスト**:
   - Dockerエンジンの実行
   - ubuntu_in_MTPコンテナの起動と管理
   - コンテナとホスト間のリソース共有の管理

4. **低レベルインターフェース**:
   - GPIOを介したハードウェア制御
   - シリアル通信の管理
   - ハードウェアドライバーの提供

### ファイルシステム

MentorPiCore_Extは、Raspberry Piの物理ストレージ（SDカードまたはUSBドライブ）上に存在し、標準的なLinuxファイルシステム構造を持っています。Dockerイメージやコンテナデータも、このファイルシステム上に保存されています。

## ubuntu_in_MTP（Dockerコンテナ）

ubuntu_in_MTPは、MentorPiCore_Ext上で動作するDockerコンテナです。Ubuntuをベースにしており、ROS2環境と関連パッケージがプリインストールされています。

### 主な役割

1. **ROS2環境の提供**:
   - ROS2フレームワークとツール
   - ROS2パッケージ（ナビゲーション、SLAM、ビジョンなど）
   - サードパーティのROS2パッケージ

2. **高レベルロボット機能**:
   - ナビゲーションと経路計画
   - マッピングとSLAM
   - コンピュータビジョンと画像処理
   - モーション制御

3. **開発環境**:
   - ROS2開発ツール
   - Pythonとその他の言語のサポート
   - デバッグとテストツール

4. **アプリケーション**:
   - デモアプリケーション
   - ユーザーインターフェース
   - データ収集と分析ツール

### コンテナ構造

ubuntu_in_MTPコンテナ内のファイルシステムは、標準的なUbuntuディストリビューションの構造に従っています。ROS2ワークスペース（ros2_ws）やサードパーティのパッケージ（third_party_ros2）などの重要なディレクトリが含まれています。

## 両者の連携方法

MentorPiCore_ExtとDockerコンテナ（ubuntu_in_MTP）は、以下の方法で連携しています：

### 1. デバイスの共有

ホストシステム（MentorPiCore_Ext）は、以下のデバイスをDockerコンテナと共有しています：

- カメラデバイス（/dev/video*）
- LiDARデバイス（/dev/ldlidar、/dev/ttyUSB*など）
- シリアルポート（/dev/ttyACM*、/dev/ttyS*など）
- GPUアクセラレーション（該当する場合）

これにより、コンテナ内のROS2ノードがハードウェアに直接アクセスできるようになります。

### 2. ネットワーク

Dockerコンテナは、ホストのネットワークモード（`--network=host`）で実行されることが多く、これによりコンテナはホストと同じネットワークインターフェースとIPアドレスを使用します。これにより：

- ROS2ノード間の通信が容易になります
- 外部デバイスからのアクセスが可能になります
- ホストとコンテナ間のネットワーク設定が簡素化されます

### 3. ボリュームマウント

特定のディレクトリがホストとコンテナ間で共有されています：

- 設定ファイル
- データディレクトリ
- ログファイル

これにより、コンテナが再起動または再作成された場合でも、重要なデータが保持されます。

### 4. 起動スクリプト

MentorPiCore_Extには、システム起動時にDockerコンテナを自動的に起動するスクリプトが含まれています。これらのスクリプトは、適切なパラメータでコンテナを起動し、必要なリソースを割り当てます。

## 使用シナリオ

### システム起動時

1. Raspberry Piの電源が入ると、MentorPiCore_Ext（Raspberry Pi OS）が起動します
2. 起動スクリプトがDockerエンジンを起動します
3. Dockerエンジンがubuntu_in_MTPコンテナを起動します
4. コンテナ内のROS2環境が初期化され、必要なノードが起動します

### 開発時

1. 開発者はSSHまたは直接接続でRaspberry Piにアクセスします
2. `docker exec`コマンドを使用してubuntu_in_MTPコンテナ内のシェルにアクセスします
3. コンテナ内でROS2コマンドを実行し、ノードを起動または停止します
4. 開発したコードをコンテナ内でテストします

### デプロイ時

1. 新しいコードまたは設定をMentorPiCore_Extにコピーします
2. 必要に応じてDockerコンテナを再起動します
3. 新しいコードがコンテナ内で実行されます

## まとめ

MentorPiロボットシステムは、ホストシステム（MentorPiCore_Ext）とDockerコンテナ（ubuntu_in_MTP）の2層アーキテクチャを採用しています。この設計により、以下の利点があります：

1. **分離**: ROS2環境が独自のコンテナで実行されるため、ベースシステムとの競合が少なくなります
2. **移植性**: Dockerコンテナは異なるRaspberry Piデバイス間で簡単に移行できます
3. **バージョン管理**: コンテナイメージをバージョン管理できるため、システムの更新とロールバックが容易です
4. **リソース管理**: コンテナに割り当てるリソースを制御できます

この2層アーキテクチャを理解することで、MentorPiロボットシステムの開発、デバッグ、およびカスタマイズがより効果的に行えるようになります。